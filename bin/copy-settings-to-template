#!/bin/bash

# This script copies the contents of the actual settings file to the example file,
# skipping over sections marked with // @git-ignore-start and // @git-ignore-end.

# Check if a file name is provided
if [[ -z "$1" ]]; then
  echo "Usage: $0 <settings-file>"
  exit 1
fi

SRC="$1"
DEST="${SRC}.example"

# Check if the source file exists
if [[ ! -f "$SRC" ]]; then
  echo "Error: Source file not found: $SRC"
  exit 1
fi

# Check if the source file is within ~/.dotfiles
if [[ "$SRC" != "$HOME/.dotfiles/"* ]]; then
  echo "Error: Source file must be within ~/.dotfiles"
  exit 1
fi

IN_IGNORE_BLOCK=0
TEMP_FILE=$(mktemp)

# Process the source file and create the example file
while IFS= read -r line; do
  if [[ "$line" =~ "// @git-ignore-start" ]]; then
    IN_IGNORE_BLOCK=1
    continue
  fi
  if [[ "$line" =~ "// @git-ignore-end" ]]; then
    IN_IGNORE_BLOCK=0
    continue
  fi
  if [[ $IN_IGNORE_BLOCK -eq 0 ]]; then
    echo "$line" >> "$TEMP_FILE"
  fi
done < "$SRC"

# Move the temporary file to the destination
mv "$TEMP_FILE" "$DEST"

echo "Copied settings from $SRC to $DEST, skipping machine-specific sections."
